<!DOCTYPE html>
<html>
<head>
  <title>DS08141210é±¼ç›†ETFç­–ç•¥è§¦å‘å™¨</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 20px; 
      line-height: 1.6;
      color: #333;
      background: #f5f7fa;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      border-bottom: 2px solid #3498db;
      padding-bottom: 15px;
      margin-bottom: 30px;
    }
    .container { 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    .config-section {
      background: #e8f4fc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #3498db;
    }
    .task { 
      margin-bottom: 20px; 
      padding: 20px; 
      background: white; 
      border: 1px solid #e0e6ed; 
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .task:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      border-color: #3498db;
    }
    .task h3 {
      color: #2c3e50;
      margin-top: 0;
      display: flex;
      align-items: center;
    }
    .task h3:before {
      content: "â€¢";
      color: #3498db;
      font-size: 24px;
      margin-right: 10px;
    }
    .task p {
      color: #5a6a7f;
      margin: 10px 0 15px;
    }
    button { 
      padding: 12px 25px; 
      background: #3498db; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
    }
    button:hover { 
      background: #2980b9; 
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button .icon {
      margin-right: 8px;
      font-size: 18px;
    }
    .status { 
      margin-top: 15px; 
      padding: 12px; 
      border-radius: 6px;
      font-size: 15px;
      line-height: 1.5;
    }
    .success {
      background-color: #d5f5e3;
      color: #27ae60;
      border-left: 4px solid #27ae60;
    }
    .error {
      background-color: #fadbd8;
      color: #c0392b;
      border-left: 4px solid #c0392b;
    }
    .info {
      background-color: #d6eaf8;
      color: #2980b9;
      border-left: 4px solid #2980b9;
    }
    .loading {
      background-color: #f0f3f7;
      color: #7f8c8d;
      border-left: 4px solid #7f8c8d;
      display: flex;
      align-items: center;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(127, 140, 141, 0.2);
      border-top: 3px solid #7f8c8d;
      border-radius: 50%;
      margin-right: 10px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .input-group { 
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.3s;
    }
    input:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    .help-text {
      font-size: 14px;
      color: #7f8c8d;
      margin-top: 6px;
    }
    .instructions {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
      border-left: 4px solid #f1c40f;
    }
    .instructions h3 {
      color: #2c3e50;
      margin-top: 0;
      display: flex;
      align-items: center;
    }
    .instructions h3:before {
      content: "ğŸ›ˆ";
      margin-right: 10px;
      font-size: 20px;
    }
    .instructions ol {
      padding-left: 20px;
    }
    .instructions li {
      margin-bottom: 15px;
      line-height: 1.5;
    }
    .instructions code {
      background: #e8f4fc;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
    footer {
      margin-top: 40px;
      text-align: center;
      color: #7f8c8d;
      font-size: 14px;
      padding-top: 20px;
      border-top: 1px solid #ecf0f1;
    }
    .step-number {
      display: inline-block;
      width: 25px;
      height: 25px;
      background: #3498db;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 25px;
      margin-right: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸŸ é±¼ç›†ETFç­–ç•¥è§¦å‘å™¨</h1>
  
  <div class="container">
    <div class="config-section">
      <h2>ğŸ“ ç¬¬ä¸€æ­¥ï¼šé…ç½®ä¿¡æ¯</h2>
      
      <div class="input-group">
        <label for="owner">ä½ çš„GitHubç”¨æˆ·åï¼š</label>
        <input type="text" id="owner" placeholder="ä¾‹å¦‚ï¼škarmyshunde-sudo">
        <div class="help-text">è¿™æ˜¯ä½ ç™»å½•GitHubçš„ç”¨æˆ·å</div>
      </div>
      
      <div class="input-group">
        <label for="repo">ç­–ç•¥ä»“åº“åç§°ï¼š</label>
        <input type="text" id="repo" placeholder="ä¾‹å¦‚ï¼šetf-strategy" value="etf-strategy">
        <div class="help-text">å­˜å‚¨ç­–ç•¥ä»£ç çš„ä»“åº“å</div>
      </div>
      
      <div class="input-group">
        <label for="pat">å®‰å…¨å¯†é’¥ (PAT)ï¼š</label>
        <input type="password" id="pat" placeholder="ç²˜è´´ä½ çš„GitHubå¯†é’¥">
        <div class="help-text">ä»GitHubè·å–çš„ä¸ªäººè®¿é—®ä»¤ç‰Œ</div>
      </div>
      
      <button onclick="saveConfig()">
        <span class="icon">ğŸ’¾</span> ä¿å­˜é…ç½®
      </button>
    </div>
    
    <h2>ğŸš€ ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ä»»åŠ¡</h2>
    
    <div class="task">
      <h3>æµ‹è¯•æ¶ˆæ¯æ¨é€ (T01)</h3>
      <p>å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡ï¼ŒéªŒè¯æ¶ˆæ¯é€šé“æ˜¯å¦æ­£å¸¸</p>
      <button onclick="triggerTest('test_message')">
        <span class="icon">ğŸ“¤</span> è§¦å‘æµ‹è¯•
      </button>
      <div id="test_message_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>æµ‹è¯•æ–°è‚¡ä¿¡æ¯ (T07)</h3>
      <p>æ¨é€å½“å¤©å¯ç”³è´­çš„æ–°è‚¡åŠæ–°ä¸Šå¸‚äº¤æ˜“è‚¡ç¥¨ä¿¡æ¯</p>
      <button onclick="triggerTest('test_new_stock')">
        <span class="icon">ğŸ’¹</span> è§¦å‘æµ‹è¯•
      </button>
      <div id="test_new_stock_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>æµ‹è¯•è‚¡ç¥¨æ± æ¨é€ (T04)</h3>
      <p>æ¨é€å½“å‰æœ‰æ•ˆçš„ETFè‚¡ç¥¨æ± åˆ°å¾®ä¿¡</p>
      <button onclick="triggerTest('test_stock_pool')">
        <span class="icon">ğŸ“Š</span> è§¦å‘æµ‹è¯•
      </button>
      <div id="test_stock_pool_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>æµ‹è¯•ç­–ç•¥æ¨é€ (T05)</h3>
      <p>æ‰§è¡Œç­–ç•¥è®¡ç®—å¹¶æ¨é€ä¹°å–ä¿¡å·åˆ°å¾®ä¿¡</p>
      <button onclick="triggerTest('test_execute')">
        <span class="icon">ğŸ¤–</span> è§¦å‘æµ‹è¯•
      </button>
      <div id="test_execute_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>é‡ç½®æ‰€æœ‰ä»“ä½ (T06)</h3>
      <p>å°†æ‰€æœ‰ETFä»“ä½é‡ç½®ä¸º0%ï¼Œç”¨äºæµ‹è¯•</p>
      <button onclick="triggerTest('test_reset')">
        <span class="icon">ğŸ”„</span> è§¦å‘æµ‹è¯•
      </button>
      <div id="test_reset_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>æµ‹è¯•å¥—åˆ©æ‰«æ (T09)</h3>
      <p>æ‰«æå¹¶æ¨é€ETFå¥—åˆ©æœºä¼šåˆ°å¾®ä¿¡</p>
      <button onclick="triggerTest('test_arbitrage')">
        <span class="icon">ğŸ”</span> è§¦å‘æµ‹è¯•
      </button>
      <div id="test_arbitrage_status" class="status"></div>
    </div>
  </div>
  
  <div class="instructions">
    <h3>ä½¿ç”¨è¯´æ˜</h3>
    <ol>
      <li>
        <span class="step-number">1</span>
        <strong>è·å–å®‰å…¨å¯†é’¥ (PAT)</strong>ï¼š
        <ul>
          <li>ç™»å½• GitHub â†’ ç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ Settings</li>
          <li>å·¦ä¾§èœå• â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)</li>
          <li>ç‚¹å‡» Generate new token â†’ å¡«å†™ Note: <code>etf-trigger</code></li>
          <li>å‹¾é€‰æƒé™ï¼š<code>repo</code> (å…¨é€‰) å’Œ <code>workflow</code></li>
          <li>ç‚¹å‡» Generate token â†’ å¤åˆ¶ç”Ÿæˆçš„å¯†é’¥</li>
        </ul>
      </li>
      <li>
        <span class="step-number">2</span>
        <strong>å¡«å†™é…ç½®ä¿¡æ¯</strong>ï¼š
        <ul>
          <li>ä½ çš„GitHubç”¨æˆ·åï¼šä½ çš„è´¦å·å</li>
          <li>ç­–ç•¥ä»“åº“åç§°ï¼š<code>etf-strategy</code>ï¼ˆä¿æŒä¸å˜ï¼‰</li>
          <li>å®‰å…¨å¯†é’¥ï¼šç²˜è´´å¤åˆ¶çš„å¯†é’¥</li>
          <li>ç‚¹å‡» <strong>ä¿å­˜é…ç½®</strong></li>
        </ul>
      </li>
      <li>
        <span class="step-number">3</span>
        <strong>è§¦å‘ä»»åŠ¡</strong>ï¼š
        <ul>
          <li>ç‚¹å‡»ä»»æ„ä»»åŠ¡æŒ‰é’®ï¼ˆå¦‚"æµ‹è¯•æ¶ˆæ¯æ¨é€"ï¼‰</li>
          <li>ç­‰å¾…1-2åˆ†é’Ÿï¼ŒæŸ¥çœ‹å¾®ä¿¡æ¨é€ç»“æœ</li>
          <li>åœ¨ <code>etf-strategy</code> ä»“åº“çš„ Actions æ ‡ç­¾é¡µæŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€</li>
        </ul>
      </li>
    </ol>
  </div>
  
  <footer>
    <p>ğŸŸ é±¼ç›†ETFæŠ•èµ„å†³ç­–ç³»ç»Ÿ | å…¨è‡ªåŠ¨é‡åŒ–ç­–ç•¥ | GitHubéƒ¨ç½²æ–¹æ¡ˆ</p>
    <p>å®‰å…¨æç¤ºï¼šå¯†é’¥ä»…ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šå‘é€åˆ°ä»»ä½•æœåŠ¡å™¨</p>
  </footer>

  <script>
    // ä¿å­˜é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
    function saveConfig() {
      const owner = document.getElementById('owner').value.trim();
      const repo = document.getElementById('repo').value.trim();
      const pat = document.getElementById('pat').value.trim();
      
      if (!owner || !repo || !pat) {
        alert('è¯·å¡«å†™æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼');
        return;
      }
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('etf_config', JSON.stringify({ 
        owner, 
        repo, 
        pat 
      }));
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      const statusDiv = document.createElement('div');
      statusDiv.className = 'status success';
      statusDiv.textContent = 'âœ“ é…ç½®å·²ä¿å­˜ï¼å…³é—­é¡µé¢åä¾ç„¶æœ‰æ•ˆ';
      document.querySelector('.config-section').appendChild(statusDiv);
      
      // 3ç§’åæ¶ˆå¤±
      setTimeout(() => {
        statusDiv.remove();
      }, 3000);
    }
    
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
    function updateStatus(task, status, className, message) {
      const statusDiv = document.getElementById(`${task}_status`);
      statusDiv.className = `status ${className}`;
      
      if (status === 'loading') {
        statusDiv.innerHTML = `<div class="loading-spinner"></div> ${message}`;
      } else {
        statusDiv.textContent = message;
      }
    }
    
    // è§¦å‘æµ‹è¯•ä»»åŠ¡
    async function triggerTest(task) {
      // æ£€æŸ¥é…ç½®æ˜¯å¦å·²ä¿å­˜
      const savedConfig = localStorage.getItem('etf_config');
      if (!savedConfig) {
        alert('è¯·å…ˆå¡«å†™å¹¶ä¿å­˜é…ç½®ä¿¡æ¯ï¼');
        return;
      }
      
      const config = JSON.parse(savedConfig);
      const { owner, repo, pat } = config;
      
      // éªŒè¯é…ç½®
      if (!owner || !repo || !pat) {
        alert('é…ç½®ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·é‡æ–°å¡«å†™å¹¶ä¿å­˜ï¼');
        return;
      }
      
      // æ›´æ–°çŠ¶æ€
      updateStatus(task, 'loading', 'loading', 'æ­£åœ¨è§¦å‘ä»»åŠ¡...');
      
      try {
        // 1. è·å–å·¥ä½œæµID
        const workflowsUrl = `https://api.github.com/repos/${owner}/${repo}/actions/workflows`;
        
        const workflowsResponse = await fetch(workflowsUrl, {
          headers: { 
            'Authorization': `Bearer ${pat}`,
            'Accept': 'application/vnd.github+json'
          }
        });
        
        if (!workflowsResponse.ok) {
          const errorData = await workflowsResponse.json();
          throw new Error(`è·å–å·¥ä½œæµå¤±è´¥: ${workflowsResponse.status} - ${errorData.message}`);
        }
        
        const workflowsData = await workflowsResponse.json();
        
        // æŸ¥æ‰¾schedule.ymlå·¥ä½œæµ
        const scheduleWorkflow = workflowsData.workflows.find(
          w => w.name === 'ETF Strategy Scheduler' || w.path.includes('schedule.yml')
        );
        
        if (!scheduleWorkflow) {
          throw new Error('æœªæ‰¾åˆ°ETFç­–ç•¥å·¥ä½œæµ');
        }
        
        const workflowId = scheduleWorkflow.id;
        
        // 2. è§¦å‘å·¥ä½œæµ
        const dispatchUrl = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflowId}/dispatches`;
        
        const dispatchResponse = await fetch(dispatchUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${pat}`,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ref: 'main',
            inputs: { task }
          })
        });
        
        if (dispatchResponse.status === 204) {
          updateStatus(task, 'success', 'success', 'âœ… è§¦å‘æˆåŠŸï¼è¯·ç­‰å¾…1-2åˆ†é’ŸæŸ¥çœ‹å¾®ä¿¡æ¨é€');
        } else {
          const errorText = await dispatchResponse.text();
          throw new Error(`è§¦å‘å¤±è´¥: ${dispatchResponse.status} - ${errorText}`);
        }
        
      } catch (error) {
        console.error('è§¦å‘é”™è¯¯:', error);
        updateStatus(task, 'error', 'error', `âŒ é”™è¯¯: ${error.message}`);
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¿å­˜çš„é…ç½®
    document.addEventListener('DOMContentLoaded', function() {
      const savedConfig = localStorage.getItem('etf_config');
      if (savedConfig) {
        const config = JSON.parse(savedConfig);
        document.getElementById('owner').value = config.owner || '';
        document.getElementById('repo').value = config.repo || '';
        document.getElementById('pat').value = config.pat || '';
        
        // æ˜¾ç¤ºé…ç½®å·²åŠ è½½
        const statusDiv = document.createElement('div');
        statusDiv.className = 'status info';
        statusDiv.textContent = 'âœ“ å·²åŠ è½½ä¿å­˜çš„é…ç½®';
        document.querySelector('.config-section').appendChild(statusDiv);
        
        setTimeout(() => {
          statusDiv.remove();
        }, 3000);
      }
    });
  </script>
</body>
</html>
